<html>
<head>
<script>
// START *** avoid caching
var scriptSDK = document.createElement('script');
scriptSDK.setAttribute('src','../ChromaCommon/ChromaSDKImpl.js?cache=' + Date.now() );
document.head.appendChild(scriptSDK);
// END *** avoid caching
</script>
<script>
var onPageLoad = function () { }
var onPageUnload = function () { }
</script>
<style>
body {
  background-color: black;
  color: white;
  font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;
}
button {
  font-size: 1.5em;
  padding: 0.5em;
  background-color: 888888;
  color: 00DD00;
}
select {
  font-size: 1.5em;
  padding: 0.5em;
  background-color: 888888;
  color: 00DD00;
}
a {
  color: white;
}
div {
  font-size: 1.2em;
}
pre {
  font-size: 1.5em;
}
td {
  font-size: 1.5em;
}
.tableInline {
  display: inline-table;
}
.tdEmpty {
  background-color: 222222;
}
.imgThumbnail {
  width: 600px;
  display: inline-table;
}
</style>
</head>
<body onload="onPageLoad()" onunload="onPageUnload()">
<img name="imgEmulatorChromaLink" style="display: none" src="emulator/EmulatorChromaLink.png"/>
<img name="imgEmulatorHeadset" style="display: none" src="emulator/EmulatorHeadset.png"/>
<img name="imgEmulatorKeyboard" style="display: none" src="emulator/EmulatorKeyboard.png"/>
<img name="imgEmulatorKeypad" style="display: none" src="emulator/EmulatorKeypad.png"/>
<img name="imgEmulatorMouse" style="display: none" src="emulator/EmulatorMouse.png"/>
<img name="imgEmulatorMousepad" style="display: none" src="emulator/EmulatorMousepad.png"/>
<h1>Generate Chroma Animations</h1>

<br/><br/>

<table border="0">
  <tr valign="top">
    <td>
Number of Layers: <input id="inputNumberOfLayers" type="text" value="5"></input><br/><br/>

Source: <select>
  <option selected>JavaScript</option>
  <option>C++</option>
  <option>UE4</option>
</select><br/><br/>

Style: <select id="selectStyle">
  <option selected>Misc</option>
  <option>Clouds</option>
  <option>Particle Systems</option>
  <option>Lines</option>
  <option>Explosion</option>
  <option>Shapes</option>
</select><br/><br/>

Random Layers: <input id="inputRandomLayers" type="checkbox" checked style="width: 50px; height: 50px"></input>
<button id="buttonRandomLayers">Apply</button><br/></br>

Random Operations: <input id="inputRandomOperations" type="checkbox" checked style="width: 50px; height: 50px"></input>
<button id="buttonRandomOperations">Apply</button><br/><br/>

Colors: <select id="selectColors">
  <option selected>Random</option>
  <option>Rainbow</option>
  <option>Black and White</option>
  <option>Blood</option>
  <option>Fire</option>
  <option>Water</option>
</select>

Background: <input id="inputBackground" type="checkbox" checked style="width: 50px; height: 50px"></input>

<button id="buttonRandomColors">Apply</button><br/><br/>

    </td>
    <td>
      Auto: <input id="inputAuto" type="checkbox" checked style="width: 50px; height: 50px"></input>
      <button id="buttonGenerateScript">Generate Script</button>
      <button id="buttonSave">Save</button>
      <button id="buttonClear">Clear</button>
      <br/><br/>
      <textarea id="outputScript" rows="20" cols="150"></textarea>
    </td>
  </tr>
</table>

<script>
var canvasTimers = [];
var animations = [];
var animationsWithLines = [];
var animationsWithExplosion = [];
var animationsWithClouds = [];
var animationsWithParticles = [];
var animationsWithShapes = [];
animations.push('Search1_Keyboard.chroma');
animations.push('Search2_Keyboard.chroma');
animations.push('Search3_Keyboard.chroma');
animations.push('Search4_Keyboard.chroma');
animationsWithClouds.push('BarrelFlash1_Keyboard.chroma');
animationsWithClouds.push('BarrelFlash2_Keyboard.chroma');
animationsWithClouds.push('BarrelFlash3_Keyboard.chroma');
animationsWithClouds.push('Clouds1_Keyboard.chroma');
animationsWithClouds.push('Clouds2_Keyboard.chroma');
animationsWithClouds.push('Clouds3_Keyboard.chroma');
animationsWithLines.push('Arc1_Keyboard.chroma');
animationsWithLines.push('Arc2_Keyboard.chroma');
animationsWithLines.push('Arc3_Keyboard.chroma');
animationsWithLines.push('Arc4_Keyboard.chroma');
animationsWithLines.push('Block1_Keyboard.chroma');
animations.push('Block2_Keyboard.chroma');
animationsWithLines.push('Bolt1_Keyboard.chroma');
animationsWithLines.push('Bolt2_Keyboard.chroma');
animationsWithLines.push('Bolt3_Keyboard.chroma');
animationsWithLines.push('Bolt4_Keyboard.chroma');
animations.push('Dragon1_Keyboard.chroma');
animations.push('Dragon2_Keyboard.chroma');
animations.push('Dragon3_Keyboard.chroma');
animations.push('Claws1_Keyboard.chroma');
animationsWithParticles.push('Energy1_Keyboard.chroma');
animationsWithLines.push('Fireball1_Keyboard.chroma');
animationsWithExplosion.push('Fork1_Keyboard.chroma');
animationsWithExplosion.push('Fork2_Keyboard.chroma');
animationsWithExplosion.push('Fork3_Keyboard.chroma');
animationsWithExplosion.push('Fork4_Keyboard.chroma');
animationsWithExplosion.push('Fork5_Keyboard.chroma');
animations.push('FreeFall1_Keyboard.chroma');
animations.push('FreeFall2_Keyboard.chroma');
animations.push('Glider1_Keyboard.chroma');
animations.push('Glider2_Keyboard.chroma');
animations.push('LaserRotate_Keyboard.chroma');
animations.push('LaserScroll_Keyboard.chroma');
animations.push('Lightning1_Keyboard.chroma');
animations.push('Lightning2_Keyboard.chroma');
animations.push('Lightning3_Keyboard.chroma');
animations.push('CircleExpanding_Keyboard.chroma');
animations.push('Hatchet_Keyboard.chroma');
animationsWithExplosion.push('Missile1_Keyboard.chroma');
animationsWithExplosion.push('Missile2_Keyboard.chroma');
animationsWithExplosion.push('Missile3_Keyboard.chroma');
animations.push('MovementUpLeft_Keyboard.chroma');
animations.push('MovementUpRight_Keyboard.chroma');
animationsWithParticles.push('Particle1_Keyboard.chroma');
animationsWithParticles.push('Particle2_Keyboard.chroma');
animationsWithParticles.push('Particle3_Keyboard.chroma');
animationsWithParticles.push('ParticleTrail1_Keyboard.chroma');
animationsWithParticles.push('ParticleTrail2_Keyboard.chroma');
animationsWithParticles.push('ParticleTrail3_Keyboard.chroma');
animationsWithParticles.push('ParticleTrail4_Keyboard.chroma');
animations.push('Projectiles_Keyboard.chroma');
animations.push('Rain1_Keyboard.chroma');
animations.push('Melee1_Keyboard.chroma');
animations.push('Ray1_Keyboard.chroma');
animations.push('Ray2_Keyboard.chroma');
animationsWithLines.push('ReactiveSpace_Keyboard.chroma');
animations.push('Reticle1_Keyboard.chroma');
animations.push('Reticle2_Keyboard.chroma');
animations.push('Reticle3_Keyboard.chroma');
animations.push('Reticle4_Keyboard.chroma');
animations.push('Spiral_Keyboard.chroma');
animationsWithParticles.push('Spray1_Keyboard.chroma');
animationsWithParticles.push('Spray2_Keyboard.chroma');
animationsWithParticles.push('Spray3_Keyboard.chroma');
animations.push('Star_Keyboard.chroma');
animations.push('Stripes1_Keyboard.chroma');
animationsWithLines.push('ThrowUpLeft_Keyboard.chroma');
animationsWithLines.push('ThrowUpRight_Keyboard.chroma');
animationsWithLines.push('ThrowUp_Keyboard.chroma');
animations.push('Tongue1_Keyboard.chroma');
animations.push('Tornado1_Keyboard.chroma');
animations.push('Trail1_Keyboard.chroma');
animations.push('Trail2_Keyboard.chroma');
animations.push('Trail3_Keyboard.chroma');
animations.push('Travel1_Keyboard.chroma');
animationsWithParticles.push('UpParticle1_Keyboard.chroma');
animationsWithParticles.push('UpParticle2_Keyboard.chroma');
animationsWithParticles.push('UpParticle3_Keyboard.chroma');
animations.push('Wisp1_Keyboard.chroma');
animations.push('Wisp2_Keyboard.chroma');
animations.push('Wisp3_Keyboard.chroma');
animations.push('X1_Keyboard.chroma');
animations.push('X2_Keyboard.chroma');
animations.push('WindMill1_Keyboard.chroma');
animations.push('MachineGun1_Keyboard.chroma');
animations.push('MachineGun2_Keyboard.chroma');
animations.push('SearchLight1_Keyboard.chroma');
animations.push('Logo1_Keyboard.chroma');
animations.push('Logo2_Keyboard.chroma');
animations.push('RocketProjectile1_Keyboard.chroma');
animations.push('Chainsaw1_Keyboard.chroma');
animations.push('WispLarge_Keyboard.chroma');
animations.push('BattleBus_Keyboard.chroma');
animations.push('BlackAndWhiteRainbow_Keyboard.chroma');
animations.push('BarRightToLeft_Keyboard.chroma');
animations.push('BarTopDown_Keyboard.chroma');
animations.push('OpenDoor1_Keyboard.chroma');
animations.push('OpenDoor2_Keyboard.chroma');
animations.push('Sword1_Keyboard.chroma');
animations.push('Block3_Keyboard.chroma');
animations.push('Block4_Keyboard.chroma');
animations.push('Arrow1_Keyboard.chroma');
animations.push('Train1_Keyboard.chroma');
animations.push('Train2_Keyboard.chroma');
animations.push('Ladder1_Keyboard.chroma');
animations.push('Ladder2_Keyboard.chroma');
animations.push('Chest1_Keyboard.chroma');
animations.push('Bird1_Keyboard.chroma');
animations.push('OutParticle1_Keyboard.chroma');
animations.push('---');
animations.push('Cinematic1_Keyboard.chroma');
animations.push('Cinematic2_Keyboard.chroma');
animations.push('Cinematic3_Keyboard.chroma');
animationsWithShapes.push('CircleLargeLeft_Keyboard.chroma');
animationsWithShapes.push('CircleLargeRight_Keyboard.chroma');
animationsWithShapes.push('CircleLarge_Keyboard.chroma');
animationsWithShapes.push('CircleLarge2_Keyboard.chroma');
animationsWithShapes.push('CircleSmallLeft_Keyboard.chroma');
animationsWithShapes.push('CircleSmallRight_Keyboard.chroma');
animationsWithShapes.push('CircleSmall_Keyboard.chroma');
animations.push('LaserA_Keyboard.chroma');
animations.push('LaserB_Keyboard.chroma');
animations.push('Llama1_Keyboard.chroma');
animations.push('Llama2_Keyboard.chroma');
animations.push('Llama3_Keyboard.chroma');
animations.push('Llama4_Keyboard.chroma');
animationsWithShapes.push('Ring1_Keyboard.chroma');
animationsWithShapes.push('Ring2_Keyboard.chroma');
animationsWithShapes.push('Ring3_Keyboard.chroma');
animationsWithShapes.push('WispBuild_Keyboard.chroma');
animations.push('XOutline_Keyboard.chroma');
animations.push('X_Keyboard.chroma');
animationsWithShapes.push('Bow1_Keyboard.chroma');
animationsWithShapes.push('Heart1_Keyboard.chroma');
animationsWithShapes.push('Damage1_Keyboard.chroma');
animationsWithShapes.push('Damage2_Keyboard.chroma');
animationsWithShapes.push('Damage3_Keyboard.chroma');
animationsWithShapes.push('Damage4_Keyboard.chroma');
animationsWithShapes.push('Damage5_Keyboard.chroma');
animationsWithShapes.push('Damage6_Keyboard.chroma');
animationsWithShapes.push('Damage7_Keyboard.chroma');
animationsWithShapes.push('Damage8_Keyboard.chroma');

var animationId = 0;

function CreateKeyboardCanvas(animationName) {
  var rootAnimations = document.getElementById('rootAnimations');
  if (animationName == '---') {
    var br = document.createElement('br');
    rootAnimations.appendChild(br);
    var br = document.createElement('hr');
    rootAnimations.appendChild(br);
    var br = document.createElement('br');
    rootAnimations.appendChild(br);
    return;
  }
  animationName = animationName.substring(0, animationName.length-'_Keyboard.chroma'.length);
  var tbl = document.createElement('table');
  tbl.setAttribute('border', '1');
  tbl.setAttribute('class', 'tableInline');
  var tr = document.createElement('tr');
  var baseLayer = 'animations/' + animationName + '_Keyboard.chroma';
  var td = document.createElement('td');
  td.innerText = 'showEffect'+animationId;
  tr.appendChild(td);
  var td = document.createElement('td');
  td.setAttribute('class', 'tdEmpty');
  tr.appendChild(td);
  tbl.appendChild(tr);

  var tr = document.createElement('tr');
  var td = document.createElement('td');
  td.setAttribute('align', 'center');
  tr.appendChild(td);
  var button = document.createElement('button');
  button.setAttribute('id', 'showEffect'+animationId);
  button.animationId = animationId;
  button.innerText = animationId;
  button.onclick = function() {
    outputScript.innerText = this.chromaSource;
    var canvasName = 'canvasShowEffect'+this.animationId;
    ChromaAnimation.playAnimation(canvasName, true);
  }
  td.appendChild(button);
  var td = document.createElement('td');
  var canvas = document.createElement('canvas');
  canvas.setAttribute('id', 'canvasShowEffect'+animationId);
  canvas.setAttribute('width', '640');
  canvas.setAttribute('height', '214');
  var ctx = canvas.getContext("2d");
  ctx.font = "30px Arial";
  ctx.fillStyle ='rgb(127, 127, 127)';
  ctx.fillText("Loading...",225,100);
  td.appendChild(canvas);
  tr.appendChild(td);
  tbl.appendChild(tr);

  rootAnimations.insertBefore(tbl, rootAnimations.children[0]);
}
getAnimation = function() {
  var animationGroup = animations;
  if (selectStyle.value == "Misc") {
    animationGroup = animations;
  } else if (selectStyle.value == "Clouds") {
    animationGroup = animationsWithClouds;
  } else if (selectStyle.value == "Particle Systems") {
    animationGroup = animationsWithParticles;
  } else if (selectStyle.value == "Lines") {
    animationGroup = animationsWithLines;
  } else if (selectStyle.value == "Explosion") {
    animationGroup = animationsWithExplosion;
  } else if (selectStyle.value == "Shapes") {
    animationGroup = animationsWithShapes;
  }
  var i = Math.floor(Math.random() * animationGroup.length) % animationGroup.length;
  var name = animationGroup[i];
  if (name == '---') {
    return getAnimation();
  }
  return '../ChromaCommon/animations/' + animationGroup[i];
}
function getLayer(layerId) {
  if (layerId == 0) {
    return 'baseLayer';
  } else {
    return 'layer' + (layerId+1);
  }
}
var numberOfLayers = 5;
var layers = [];
var operations = [];
var colors = [];
randomizeLayers = function() {
  layers = [];
  for (var i = 0; i < numberOfLayers; ++i) {
    if (i == 0) {
      layers.push("../ChromaCommon/animations/Blank_Keyboard.chroma");
      continue;
    }
    var animationName = "";
    for (var tries = 0; tries < 3; ++tries) {
      animationName = getAnimation();
      if (!layers.includes(animationName)) {
        layers.push(animationName);
        animationName = "";
        break;
      }
    }
    if (animationName != "") {
      layers.push(animationName);
    }
  }
}
buttonRandomLayers.onclick = function() {
  randomizeLayers();
  generateScript();
}
randomizeOperations = function() {
  operations = [];
  for (var i = 0; i < numberOfLayers; ++i) {
    var ops = [];
    ops.push(Math.floor(Math.random() * 3));
    ops.push(Math.floor(Math.random() * 6));
    operations.push(ops);
  }
}
buttonRandomOperations.onclick = function() {
  randomizeOperations();
  generateScript();
}
randomizeColors = function() {
  colors = [];
  for (var i = 0; i < 10; ++i) {
    var red = Math.floor(Math.random() * 255);
    var green = Math.floor(Math.random() * 255);
    var blue = Math.floor(Math.random() * 255);
    var color = red | (green << 8) | (blue << 16);
    colors.push(color);
  }
}
randomizeColors(); //set initial colors
setRainbowColors = function() {
  colors = [];
  colors.push(ChromaAnimation.getRGB(255, 0, 0));
  colors.push(ChromaAnimation.getRGB(255, 127, 0));
  colors.push(ChromaAnimation.getRGB(255, 255, 0));
  colors.push(ChromaAnimation.getRGB(0, 255, 0));
  colors.push(ChromaAnimation.getRGB(0, 0, 255));
  colors.push(ChromaAnimation.getRGB(75, 0, 130));
  colors.push(ChromaAnimation.getRGB(148, 0, 211));
}
setBlackAndWhiteColors = function() {
  colors = [];
  colors.push(ChromaAnimation.getRGB(255, 255, 255));
  colors.push(ChromaAnimation.getRGB(200, 200, 200));
  colors.push(ChromaAnimation.getRGB(127, 127, 127));
  colors.push(ChromaAnimation.getRGB(63, 63, 63));
  colors.push(ChromaAnimation.getRGB(32, 32, 32));
  colors.push(ChromaAnimation.getRGB(0, 0, 0));
}
setBloodColors = function() {
  colors = [];
  colors.push(ChromaAnimation.getRGB(255, 0, 0));
  colors.push(ChromaAnimation.getRGB(127, 0, 0));
  colors.push(ChromaAnimation.getRGB(64, 0, 0));
}
setFireColors = function() {
  colors = [];
  colors.push(ChromaAnimation.getRGB(255, 0, 0));
  colors.push(ChromaAnimation.getRGB(255, 32, 0));
  colors.push(ChromaAnimation.getRGB(255, 64, 0));
  colors.push(ChromaAnimation.getRGB(255, 100, 0));
  colors.push(ChromaAnimation.getRGB(255, 127, 0));
  colors.push(ChromaAnimation.getRGB(255, 200, 0));
  colors.push(ChromaAnimation.getRGB(255, 255, 0));
}
setWaterColors = function() {
  colors = [];
  colors.push(ChromaAnimation.getRGB(0, 0, 255));
  colors.push(ChromaAnimation.getRGB(0, 32, 255));
  colors.push(ChromaAnimation.getRGB(0, 64, 255));
  colors.push(ChromaAnimation.getRGB(0, 100, 255));
  colors.push(ChromaAnimation.getRGB(0, 127, 255));
  colors.push(ChromaAnimation.getRGB(0, 200, 255));
  colors.push(ChromaAnimation.getRGB(0, 255, 255));
}
generateScript = function() {
  var text = "";
  var newline = "\n";
  var baseLayer = "";
  for (var layerId = 0; layerId < numberOfLayers; ++layerId) {
    if (layerId == 0) {
      baseLayer = layers[0];
    }
    text += "var " + getLayer(layerId) + " = '"+layers[layerId]+"';" + newline;
  }
  for (var layerId = 0; layerId < numberOfLayers; ++layerId) {
    text += "ChromaAnimation.closeAnimation("+ getLayer(layerId) +");" + newline;
  }
  for (var layerId = 0; layerId < numberOfLayers; ++layerId) {
    var indent = "";
    for (var i = 0; i < layerId; ++i){
      indent += "  ";
    }
    if (layerId == 0) {
      text += "ChromaAnimation.openAnimation(baseLayer, function(baseAnimation) {" + newline;
    } else {
      text += indent + "ChromaAnimation.openAnimation(layer"+(layerId+1)+", function(layer"+(layerId+1)+"Animation) {" + newline;
    }
  }
  var indent = "";
  for (var i = 0; i < numberOfLayers; ++i){
    indent += "  ";
  }
  text += indent + "var frameCount = ChromaAnimation.getFrameCount(baseLayer);" + newline;
  for (var layerId = 1; layerId < numberOfLayers; ++layerId) {
    text += indent + "var frames = ChromaAnimation.getFrameCount("+ getLayer(layerId) +");" + newline;
    text += indent + "frameCount = Math.max(frameCount, frames);" + newline;
  }
  for (var layerId = 1; layerId < numberOfLayers; ++layerId) {
    text += indent + "var frames = ChromaAnimation.getFrameCount("+ getLayer(layerId) +");" + newline;
    text += indent + "if (frames == 1) ChromaAnimation.duplicateFirstFrame("+ getLayer(layerId) +", frameCount);" + newline;
  }
  var color = colors[Math.floor(Math.random() * colors.length)];
  var red = ChromaAnimation.getRed(color);
  var green = ChromaAnimation.getGreen(color);
  var blue = ChromaAnimation.getBlue(color);
  if (inputBackground.checked) {
    text += indent + "ChromaAnimation.makeBlankFramesRGB(baseLayer, frameCount, 0.1, "+red+", "+green+", "+blue+");" + newline;
  } else {
    text += indent + "ChromaAnimation.makeBlankFrames(baseLayer, frameCount, 0.1, 0);" + newline;
  }
  for (var layerId = 1; layerId < numberOfLayers; ++layerId) {
    switch (operations[layerId][0]) {
      case 0:
        var color = colors[Math.floor(Math.random() * colors.length)];
        var red = ChromaAnimation.getRed(color);
        var green = ChromaAnimation.getGreen(color);
        var blue = ChromaAnimation.getBlue(color);
        text += indent + "ChromaAnimation.multiplyIntensityAllFramesRGB("+ getLayer(layerId) +", "+red+", "+green+", "+blue+");" + newline;
        break;
      case 1:
        var threshold = Math.floor(Math.random() * 255);
        var color = colors[Math.floor(Math.random() * colors.length)];
        var red = ChromaAnimation.getRed(color);
        var green = ChromaAnimation.getGreen(color);
        var blue = ChromaAnimation.getBlue(color);
        text += indent + "ChromaAnimation.fillThresholdColorsAllFramesRGB("+ getLayer(layerId) +", "+threshold+", "+red+", "+green+", "+blue+");" + newline;
        break;
      case 2:
        var minThreshold = Math.floor(Math.random() * 127);
        var color = colors[Math.floor(Math.random() * colors.length)];
        var minRed = ChromaAnimation.getRed(color);
        var minGreen = ChromaAnimation.getGreen(color);
        var minBlue = ChromaAnimation.getBlue(color);
        var maxThreshold = Math.floor(Math.random() * 127);
        var color = colors[Math.floor(Math.random() * colors.length)];
        var maxRed = ChromaAnimation.getRed(color);
        var maxGreen = ChromaAnimation.getGreen(color);
        var maxBlue = ChromaAnimation.getBlue(color);
        text += indent + "ChromaAnimation.fillThresholdColorsMinMaxAllFramesRGB("+ getLayer(layerId) +", "+minThreshold+", "+minRed+", "+minGreen+", "+minBlue+", "+maxThreshold+", "+maxRed+", "+maxGreen+", "+maxBlue+");" + newline;
        break;
    }
  }
  for (var layerId = 1; layerId < numberOfLayers; ++layerId) {
    switch (operations[layerId][1]) {
      case 0:
        text += indent + "ChromaAnimation.copyNonZeroAllKeysAllFrames("+ getLayer(layerId) +", baseLayer);" + newline;
        break;
      case 1:
        text += indent + "ChromaAnimation.copyNonZeroTargetAllKeysAllFrames("+ getLayer(layerId) +", baseLayer);" + newline;
        break;
      case 2:
        text += indent + "ChromaAnimation.addNonZeroAllKeysAllFrames("+ getLayer(layerId) +", baseLayer);" + newline;
        break;
      case 3:
        text += indent + "ChromaAnimation.addNonZeroTargetAllKeysAllFrames("+ getLayer(layerId) +", baseLayer);" + newline;
        break;
      case 4:
        text += indent + "ChromaAnimation.subtractNonZeroAllKeysAllFrames("+ getLayer(layerId) +", baseLayer);" + newline;
        break;
      case 5:
        text += indent + "ChromaAnimation.subtractNonZeroTargetAllKeysAllFrames("+ getLayer(layerId) +", baseLayer);" + newline;
        break;
    }
  }

  text += indent + "ChromaAnimation.setChromaCustomFlag(baseLayer, true);" + newline;
  text += indent + "ChromaAnimation.setChromaCustomColorAllFrames(baseLayer);" + newline;
  text += indent + "ChromaAnimation.overrideFrameDuration(baseLayer, 0.033);" + newline;
  text += indent + "ChromaAnimation.playAnimation(baseLayer, true);" + newline;

  text += indent + "ChromaAnimation.closeAnimation('canvasShowEffect"+animationId+"');" + newline;
  text += indent + "displayCanvas(baseLayer, 'canvasShowEffect"+animationId+"');" + newline;

  for (var layerId = numberOfLayers - 1; layerId >= 0; --layerId) {
    var indent = "";
    for (var i = 0; i < layerId; ++i){
      indent += "  ";
    }
    text += indent + "});" + newline;
  }
  outputScript.innerText = text;
  var prev = outputScript.innerHTML;
  do {
    prev = outputScript.innerHTML;
    outputScript.innerHTML = outputScript.innerHTML.replace('&lt;br&gt;', '\r\n');
  } while (prev != outputScript.innerHTML);

  var button = document.getElementById("showEffect"+animationId);
  if (button != undefined) {
    button.chromaSource = text;
  }
  var canvasName = 'canvasShowEffect'+this.animationId;
  ChromaAnimation.closeAnimation(canvasName);
  eval(text);
}
generateColors = function() {
  if (selectColors.value == "Random") {
    randomizeColors();
  } else if (selectColors.value == "Rainbow") {
    setRainbowColors();
  } else if (selectColors.value == "Black and White") {
    setBlackAndWhiteColors();
  } else if (selectColors.value == "Blood") {
    setBloodColors();
  } else if (selectColors.value == "Fire") {
    setFireColors();
  } else if (selectColors.value == "Water") {
    setWaterColors();
  }
}
buttonRandomColors.onclick = function() {
  generateColors();
  generateScript();
}
buttonGenerateScript.onclick = function() {
  numberOfLayers = Math.floor(parseInt(inputNumberOfLayers.value));
  if (layers.length != numberOfLayers ||
    inputRandomLayers.checked) {
    randomizeLayers();
  }
  if (operations.length != numberOfLayers ||
    inputRandomOperations.checked) {
    randomizeOperations();
  }
  generateColors();
  generateScript();
}
buttonSave.onclick = function() {
  ++animationId;
  CreateKeyboardCanvas("canvasShowEffect"+animationId);
  generateScript();
}
buttonClear.onclick = function() {
  for (var canvasName in canvasTimers) {
    if (canvasTimers[canvasName] != undefined) {
      clearTimeout(canvasTimers[canvasName]);
      canvasTimers[canvasName] = undefined;
    }
    canvasTimers = [];
  }
  while (rootAnimations.firstChild) {
    rootAnimations.removeChild(rootAnimations.firstChild);
  }
  animationId = 1;
  CreateKeyboardCanvas("canvasShowEffect"+animationId);
  generateScript();
}
var intervalAuto = undefined;
inputAuto.onclick = function() {
  if (intervalAuto != undefined) {
    clearInterval(intervalAuto);
    intervalAuto = undefined;
  }
  if (inputAuto.checked) {
    intervalAuto = setInterval(function() {
      ++animationId;
      CreateKeyboardCanvas("canvasShowEffect"+animationId);
      buttonGenerateScript.onclick();
    }, 250);
  }
}
inputAuto.onclick();
</script>

<br/><br/>

<div id="rootAnimations"/>

<br/><br/>

</body>
<script>
// browser function to determine tab is hidden
// ref: https://stackoverflow.com/questions/7389328/detect-if-browser-tab-has-focus/46719827#46719827
var browserTabIsVisible = true;
handleTabVisibility = function() {

  // check the visiblility of the page
  var hidden, visibilityState, visibilityChange;

  if (typeof document.hidden !== "undefined") {
      hidden = "hidden", visibilityChange = "visibilitychange", visibilityState = "visibilityState";
  }
  else if (typeof document.mozHidden !== "undefined") {
      hidden = "mozHidden", visibilityChange = "mozvisibilitychange", visibilityState = "mozVisibilityState";
  }
  else if (typeof document.msHidden !== "undefined") {
      hidden = "msHidden", visibilityChange = "msvisibilitychange", visibilityState = "msVisibilityState";
  }
  else if (typeof document.webkitHidden !== "undefined") {
      hidden = "webkitHidden", visibilityChange = "webkitvisibilitychange", visibilityState = "webkitVisibilityState";
  }

  if (typeof document.addEventListener === "undefined" || typeof hidden === "undefined") {
      // not supported
  }
  else {
      document.addEventListener(visibilityChange, function() {
          //console.log('hidden', document[hidden]);
          //console.log('visibilityState: ', document[visibilityState]);

          switch (document[visibilityState]) {
          case "visible":
              // visible
              browserTabIsVisible = true;
              break;
          case "hidden":
              // hidden
              browserTabIsVisible = false;
              break;
          }
      }, false);
  }

};
// end of browser function


var chromaSDK = undefined;
var initialized = false;
var exampleInterval = undefined;
var pageHadFocus = undefined;
var drawInProgress = false;
function chromaSetStaticColor(color) {
  if (!initialized) {
    console.log('chromaSetStaticColor', 'not initialized!');
    return;
  }
  ChromaAnimation.staticColorAll(color);
}
detectWindowFocus = function() {
  if (browserTabIsVisible == true) {
    if (pageHadFocus != true) {
      chromaSDK.init();
      setTimeout(function() {
        initialized = true;
        //console.log('set static color');
        chromaSetStaticColor(0x808080);
      }, 100);
      pageHadFocus = true;
      //console.log('page has focus');
    } else {
      //console.log('page already has focus');
    }
  } else {
    if (pageHadFocus == true) {
      ChromaAnimation.clearAll();
      chromaSDK.uninit();
      pageHadFocus = false;
      initialized = false;
      //console.log('page lost focus');
    }
  }
}
onPageLoad = function () {
  handleTabVisibility();
  chromaSDK = new ChromaSDK();
  detectWindowFocus();
  setInterval(function() {
    detectWindowFocus();
  }, 1000);
};
onPageUnload = function () {
  if (chromaSDK != undefined &&
    initialized) {
    chromaSDK.uninit()
  }
};
function lerp (start, end, amt) {
  return (1-amt)*start+amt*end;
}
function lerpColor (from, to, t) {
  var red = Math.floor(lerp((from & 0xFF), (to & 0xFF), t));
  var green = Math.floor(lerp((from & 0xFF00) >> 8, (to & 0xFF00) >> 8, t));
  var blue = Math.floor(lerp((from & 0xFF0000) >> 16, (to & 0xFF0000) >> 16, t));
  var color = red | (green << 8) | (blue << 16);
  return color;
}
exampleReset = function () {
  if (exampleInterval != undefined) {
    clearInterval(exampleInterval);
    exampleInterval = undefined;
  }
};
getRGBString = function(red, green, blue) {
  return "rgb("+red+", "+green+", "+blue+")";
}
getRGBAString = function(red, green, blue, alpha) {
  return "rgba(" + red + ", " + green + ", " + blue + ", " + alpha + ")";
}
function drawKeyboard(canvasName, animationName) {

  var animation = ChromaAnimation.getAnimation(animationName);
  if (animation == undefined) {
    return;
  }

  if (animation.DeviceType != EChromaSDKDeviceTypeEnum.DE_2D ||
    animation.Device != EChromaSDKDevice2DEnum.DE_Keyboard) {
    return;
  }

  var canvas = document.getElementById(canvasName);
  var ctx = canvas.getContext("2d");

  ctx.fillStyle = getRGBString(0, 0, 0);
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.stroke();

  var map = {};
  map['RZKEY.RZKEY_ESC'] = [46, 5, 27, 28];
  map['RZKEY.RZKEY_F1'] = [113, 5, 25, 28];
  map['RZKEY.RZKEY_F2'] = [139, 5, 25, 28];
  map['RZKEY.RZKEY_F3'] = [165, 5, 25, 28];
  map['RZKEY.RZKEY_F4'] = [190, 5, 26, 28];
  map['RZKEY.RZKEY_F5'] = [222, 5, 24, 28];
  map['RZKEY.RZKEY_F6'] = [248, 5, 24, 28];
  map['RZKEY.RZKEY_F7'] = [274, 5, 24, 28];
  map['RZKEY.RZKEY_F8'] = [299, 5, 25, 28];
  map['RZKEY.RZKEY_F9'] = [330, 5, 25, 28];
  map['RZKEY.RZKEY_F10'] = [356, 5, 25, 28];
  map['RZKEY.RZKEY_F11'] = [382, 5, 25, 28];
  map['RZKEY.RZKEY_F12'] = [407, 5, 25, 28];
  map['RZKEY.RZKEY_1'] = [72, 37, 26, 25];
  map['RZKEY.RZKEY_2'] = [98, 37, 25, 25];
  map['RZKEY.RZKEY_3'] = [124, 37, 25, 25];
  map['RZKEY.RZKEY_4'] = [150, 37, 25, 25];
  map['RZKEY.RZKEY_5'] = [176, 37, 24, 25];
  map['RZKEY.RZKEY_6'] = [202, 37, 24, 25];
  map['RZKEY.RZKEY_7'] = [228, 37, 24, 25];
  map['RZKEY.RZKEY_8'] = [253, 37, 25, 25];
  map['RZKEY.RZKEY_9'] = [279, 37, 25, 25];
  map['RZKEY.RZKEY_0'] = [305, 37, 25, 25];
  map['RZKEY.RZKEY_A'] = [92, 89, 25, 25];
  map['RZKEY.RZKEY_B'] = [208, 114, 25, 26];
  map['RZKEY.RZKEY_C'] = [156, 114, 26, 26];
  map['RZKEY.RZKEY_D'] = [144, 89, 24, 25];
  map['RZKEY.RZKEY_E'] = [137, 63, 25, 25];
  map['RZKEY.RZKEY_F'] = [169, 89, 25, 25];
  map['RZKEY.RZKEY_G'] = [195, 89, 25, 25];
  map['RZKEY.RZKEY_H'] = [221, 89, 25, 25];
  map['RZKEY.RZKEY_I'] = [266, 63, 25, 25];
  map['RZKEY.RZKEY_J'] = [247, 89, 25, 25];
  map['RZKEY.RZKEY_K'] = [272, 89, 25, 25];
  map['RZKEY.RZKEY_L'] = [298, 89, 25, 25];
  map['RZKEY.RZKEY_M'] = [259, 114, 25, 26];
  map['RZKEY.RZKEY_N'] = [233, 114, 26, 26];
  map['RZKEY.RZKEY_O'] = [292, 63, 25, 25];
  map['RZKEY.RZKEY_P'] = [318, 63, 25, 25];
  map['RZKEY.RZKEY_Q'] = [86, 63, 24, 25];
  map['RZKEY.RZKEY_R'] = [163, 63, 25, 25];
  map['RZKEY.RZKEY_S'] = [118, 89, 25, 25];
  map['RZKEY.RZKEY_T'] = [188, 63, 26, 25];
  map['RZKEY.RZKEY_U'] = [240, 63, 25, 25];
  map['RZKEY.RZKEY_V'] = [182, 114, 25, 26];
  map['RZKEY.RZKEY_W'] = [112, 63, 24, 25];
  map['RZKEY.RZKEY_X'] = [131, 114, 25, 26];
  map['RZKEY.RZKEY_Y'] = [214, 63, 25, 25];
  map['RZKEY.RZKEY_Z'] = [105, 114, 25, 26];
  map['RZKEY.RZKEY_NUMLOCK'] = [521, 37, 26, 26];
  map['RZKEY.RZKEY_NUMPAD0'] = [521, 140, 52, 26];
  map['RZKEY.RZKEY_NUMPAD1'] = [521, 114, 26, 26];
  map['RZKEY.RZKEY_NUMPAD2'] = [547, 114, 26, 26];
  map['RZKEY.RZKEY_NUMPAD3'] = [573, 114, 26, 26];
  map['RZKEY.RZKEY_NUMPAD4'] = [521, 88, 26, 26];
  map['RZKEY.RZKEY_NUMPAD5'] = [547, 88, 26, 26];
  map['RZKEY.RZKEY_NUMPAD6'] = [573, 88, 26, 26];
  map['RZKEY.RZKEY_NUMPAD7'] = [521, 63, 26, 25];
  map['RZKEY.RZKEY_NUMPAD8'] = [547, 63, 26, 25];
  map['RZKEY.RZKEY_NUMPAD9'] = [573, 63, 26, 25];
  map['RZKEY.RZKEY_NUMPAD_DIVIDE'] = [547, 37, 26, 26];
  map['RZKEY.RZKEY_NUMPAD_MULTIPLY'] = [573, 37, 26, 26];
  map['RZKEY.RZKEY_NUMPAD_SUBTRACT'] = [598, 37, 26, 26];
  map['RZKEY.RZKEY_NUMPAD_ADD'] = [598, 63, 26, 51];
  map['RZKEY.RZKEY_NUMPAD_ENTER'] = [598, 114, 26, 52];
  map['RZKEY.RZKEY_NUMPAD_DECIMAL'] = [572, 140, 52, 26];
  map['RZKEY.RZKEY_PRINTSCREEN'] = [438, 5, 26, 28];
  map['RZKEY.RZKEY_SCROLL'] = [464, 5, 26, 28];
  map['RZKEY.RZKEY_PAUSE'] = [490, 5, 26, 28];
  map['RZKEY.RZKEY_INSERT'] = [438, 37, 26, 27];
  map['RZKEY.RZKEY_HOME'] = [464, 37, 26, 27];
  map['RZKEY.RZKEY_PAGEUP'] = [490, 37, 26, 27];
  map['RZKEY.RZKEY_DELETE'] = [438, 63, 26, 27];
  map['RZKEY.RZKEY_END'] = [464, 63, 26, 27];
  map['RZKEY.RZKEY_PAGEDOWN'] = [490, 63, 26, 27];
  map['RZKEY.RZKEY_UP'] = [464, 114, 26, 26];
  map['RZKEY.RZKEY_LEFT'] = [438, 140, 26, 26];
  map['RZKEY.RZKEY_DOWN'] = [464, 140, 26, 26];
  map['RZKEY.RZKEY_RIGHT'] = [490, 140, 25, 26];
  map['RZKEY.RZKEY_TAB'] = [46, 63, 39, 25];
  map['RZKEY.RZKEY_CAPSLOCK'] = [46, 89, 45, 25];
  map['RZKEY.RZKEY_BACKSPACE'] = [382, 37, 50, 25];
  map['RZKEY.RZKEY_ENTER'] = [375, 89, 57, 25];
  map['RZKEY.RZKEY_LCTRL'] = [46, 140, 39, 26];
  map['RZKEY.RZKEY_LWIN'] = [86, 140, 25, 26];
  map['RZKEY.RZKEY_LALT'] = [111, 140, 38, 26];
  map['RZKEY.RZKEY_SPACE'] = [149, 140, 156, 26];
  map['RZKEY.RZKEY_RALT'] = [305, 140, 37, 26];
  map['RZKEY.RZKEY_FN'] = [342, 140, 26, 26];
  map['RZKEY.RZKEY_RMENU'] = [368, 140, 26, 26];
  map['RZKEY.RZKEY_RCTRL'] = [395, 140, 37, 26];
  map['RZKEY.RZKEY_LSHIFT'] = [46, 114, 58, 26];
  map['RZKEY.RZKEY_RSHIFT'] = [362, 114, 70, 26];
  map['RZKEY.RZKEY_MACRO1'] = [15, 37, 27, 25];
  map['RZKEY.RZKEY_MACRO2'] = [15, 62, 27, 26];
  map['RZKEY.RZKEY_MACRO3'] = [15, 88, 27, 26];
  map['RZKEY.RZKEY_MACRO4'] = [15, 114, 27, 26];
  map['RZKEY.RZKEY_MACRO5'] = [15, 140, 27, 26];
  map['RZKEY.RZKEY_OEM_1'] = [46, 37, 26, 25];
  map['RZKEY.RZKEY_OEM_2'] = [330, 37, 25, 25];
  map['RZKEY.RZKEY_OEM_3'] = [356, 37, 25, 25];
  map['RZKEY.RZKEY_OEM_4'] = [343, 63, 25, 25];
  map['RZKEY.RZKEY_OEM_5'] = [369, 63, 25, 25];
  map['RZKEY.RZKEY_OEM_6'] = [394, 63, 38, 25];
  map['RZKEY.RZKEY_OEM_7'] = [324, 89, 25, 25];
  map['RZKEY.RZKEY_OEM_8'] = [350, 89, 24, 25];
  map['RZKEY.RZKEY_OEM_9'] = [285, 114, 25, 26];
  map['RZKEY.RZKEY_OEM_10'] = [311, 114, 25, 26];
  map['RZKEY.RZKEY_OEM_11'] = [337, 114, 25, 26];
  map['RZKEY.RZKEY_EUR_1'] = [0, 0, 0, 0];
  map['RZKEY.RZKEY_EUR_2'] = [0, 0, 0, 0];
  map['RZKEY.RZKEY_JPN_1'] = [0, 0, 0, 0];
  map['RZKEY.RZKEY_JPN_2'] = [0, 0, 0, 0];
  map['RZKEY.RZKEY_JPN_3'] = [0, 0, 0, 0];
  map['RZKEY.RZKEY_JPN_4'] = [0, 0, 0, 0];
  map['RZKEY.RZKEY_JPN_5'] = [0, 0, 0, 0];
  map['RZKEY.RZKEY_KOR_1'] = [0, 0, 0, 0];
  map['RZKEY.RZKEY_KOR_2'] = [0, 0, 0, 0];
  map['RZKEY.RZKEY_KOR_3'] = [0, 0, 0, 0];
  map['RZKEY.RZKEY_KOR_4'] = [0, 0, 0, 0];
  map['RZKEY.RZKEY_KOR_5'] = [0, 0, 0, 0];
  map['RZKEY.RZKEY_KOR_6'] = [0, 0, 0, 0];
  map['RZKEY.RZKEY_KOR_7'] = [0, 0, 0, 0];
  map['RZKEY.RZKEY_INVALID'] = [0, 0, 0, 0];
  map['RZLED.RZLED_LOGO'] = [309, 185, 24, 25];

  var frameCount = animation.getFrameCount();
  //console.log('frameCount', frameCount);
  var maxRow = ChromaAnimation.getMaxRow(EChromaSDKDevice2DEnum.DE_Keyboard);
  var maxColumn = ChromaAnimation.getMaxColumn(EChromaSDKDevice2DEnum.DE_Keyboard);
  var frameId = animation.CurrentIndex;
  //console.log('frameId', frameId);
  if (frameId >= 0 && frameId < frameCount) {
    //var frame = animation.Frames[frameId];
    var frame = animation.Frames[animation.CurrentIndex];
    var colors = frame.Colors;

    for (var key in RZKEY) {
      //console.log('key', 'RZKEY.'+key, RZKEY[key], 'i', i, 'j', j, map[keyDesc]);
      var val = RZKEY[key];
      if (val == RZKEY.RZKEY_INVALID) {
        continue;
      }
      var i = getHighByte(val);
      var row = colors[i];
      var j = getLowByte(val);
      var color = row[j];
      var red = color & 0xFF;
      var green = (color & 0xFF00) >> 8;
      var blue = (color & 0xFF0000) >> 16;
      var keyDesc = 'RZKEY.'+key;
      var coords = map[keyDesc];

      var color = getRGBString(red, green, blue);
      ctx.fillStyle = color;
      ctx.fillRect(coords[0],coords[1],coords[2],coords[3]);
      ctx.stroke();
    }

    for (var key in RZLED) {
      var val = RZKEY[key];
      var i = getHighByte(val);
      var row = colors[i];
      var j = getLowByte(val);
      var color = row[j];
      var red = color & 0xFF;
      var green = (color & 0xFF00) >> 8;
      var blue = (color & 0xFF0000) >> 16;
      var keyDesc = 'RZLED.'+key;
      var coords = map[keyDesc];

      var color = getRGBString(red, green, blue);
      ctx.fillStyle = color;
      var a = coords[0];
      var b = coords[1];
      var c = coords[2];
      var d = coords[3];
      ctx.fillRect(a,b,c,d);
      ctx.stroke();
    }

    var drawWidth = canvas.width;
    var drawHeight = canvas.height;
    ctx.drawImage(imgEmulatorKeyboard, 0, 0, drawWidth, drawHeight);
  }

  var duration = Number(animation.getDuration());
  duration = Math.max(duration, 0.033);
  if (canvasTimers[canvasName] != undefined) {
    clearTimeout(canvasTimers[canvasName]);
    canvasTimers[canvasName] = undefined;
  }
  canvasTimers[canvasName] = setTimeout(function() {
    animation.CurrentIndex = (animation.CurrentIndex + 1) % animation.getFrameCount();
    drawKeyboard(canvasName, animationName);
  }, duration * 1000);
}
displayCanvas = function(baseLayer, canvasName) {
  if (ChromaAnimation.getAnimation(canvasName) == undefined) {
    ChromaAnimation.copyAnimation(baseLayer, canvasName);
    ChromaAnimation.multiplyIntensityAllFrames(canvasName, 1.5); //slightly brighter
    drawKeyboard(canvasName, canvasName);
  }
  drawInProgress = false;
}

</script>
</html>
